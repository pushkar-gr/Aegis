<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Services - Aegis Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="text-white text-xl font-bold">Aegis</div>
                    <div class="ml-10 flex items-baseline space-x-4" id="navigation"></div>
                </div>
                <div id="profileSection"></div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">Services Management</h1>
                <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                    Add Service
                </button>
            </div>

            <!-- Services Table -->
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP:Port</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="servicesTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Services will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Service Modal -->
    <div id="serviceModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="modalTitle">Add Service</h3>
                <form id="serviceForm" class="space-y-4">
                    <input type="hidden" id="serviceId">
                    <div>
                        <label for="serviceName" class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                        <input type="text" id="serviceName" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="serviceIpPort" class="block text-sm font-medium text-gray-700 mb-1">IP:Port *</label>
                        <input type="text" id="serviceIpPort" required placeholder="e.g., 192.168.1.10:8080"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="serviceDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="serviceDescription" rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 mt-4">
                        <button type="button" onclick="closeModal()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                        <button type="submit" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/components.js"></script>
    <script>
        let services = [];

        // Check authentication
        if (!requireAuth()) {
            // Will redirect in requireAuth
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('navigation').innerHTML = createNavigation('services.html');
            document.getElementById('profileSection').innerHTML = createProfileDropdown();
            
            await loadServices();

            // Event delegation for table buttons
            document.getElementById('servicesTableBody').addEventListener('click', (e) => {
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                
                const serviceId = parseInt(button.dataset.serviceId);
                const action = button.dataset.action;
                
                if (action === 'edit') {
                    openEditModal(serviceId);
                } else if (action === 'delete') {
                    deleteService(serviceId);
                }
            });
        });

        async function loadServices() {
            try {
                showLoading();
                services = await API.getServices() || [];
                renderServices();
            } catch (error) {
                showToast('Failed to load services', 'error');
            } finally {
                hideLoading();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderServices() {
            const tbody = document.getElementById('servicesTableBody');
            
            if (services.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                            No services found. Click "Add Service" to create one.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = services.map(service => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${escapeHtml(service.name)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHtml(service.ip_port)}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${escapeHtml(service.description || '-')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button data-action="edit" data-service-id="${service.id}" class="text-blue-600 hover:text-blue-900">Edit</button>
                        <button data-action="delete" data-service-id="${service.id}" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add Service';
            document.getElementById('serviceForm').reset();
            document.getElementById('serviceId').value = '';
            document.getElementById('serviceModal').classList.remove('hidden');
        }

        function openEditModal(serviceId) {
            const service = services.find(s => s.id === serviceId);
            if (!service) return;

            document.getElementById('modalTitle').textContent = 'Edit Service';
            document.getElementById('serviceId').value = service.id;
            document.getElementById('serviceName').value = service.name;
            document.getElementById('serviceIpPort').value = service.ip_port;
            document.getElementById('serviceDescription').value = service.description || '';
            document.getElementById('serviceModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('serviceModal').classList.add('hidden');
        }

        document.getElementById('serviceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const serviceId = document.getElementById('serviceId').value;
            const serviceData = {
                name: document.getElementById('serviceName').value,
                ip_port: document.getElementById('serviceIpPort').value,
                description: document.getElementById('serviceDescription').value
            };

            try {
                showLoading();
                if (serviceId) {
                    await API.updateService(serviceId, serviceData);
                    showToast('Service updated successfully', 'success');
                } else {
                    await API.createService(serviceData);
                    showToast('Service created successfully', 'success');
                }
                closeModal();
                await loadServices();
            } catch (error) {
                showToast('Failed to save service: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        });

        async function deleteService(serviceId) {
            if (!confirmDialog('Are you sure you want to delete this service?')) {
                return;
            }

            try {
                showLoading();
                await API.deleteService(serviceId);
                showToast('Service deleted successfully', 'success');
                await loadServices();
            } catch (error) {
                showToast('Failed to delete service: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html>
